## **Oracle CLUSTERS**

---

### **1️⃣ What is a Cluster in Oracle?**

* A **Cluster** is a **schema object** that **stores related tables together** physically in the same data blocks based on a common column (called the **cluster key**).
* Instead of storing each table separately, Oracle stores rows with the **same cluster key value** **in the same block**.
* This means if you query by the cluster key, Oracle can **fetch related rows from multiple tables in fewer block reads** → **faster joins**.

---

### **2️⃣ Why Use a Cluster?**

**Advantages**
✅ Faster joins between tables that are always queried together.
✅ Reduces disk I/O (because related data is physically near each other).
✅ Saves space if common columns are stored once in the cluster (for **indexed clusters**).

**Disadvantages**
❌ Slower inserts and updates (because Oracle must place data in the right block).
❌ Less beneficial if you often query tables separately.
❌ Requires a cluster index or hash definition before inserting data.

---

### **3️⃣ Types of Clusters**

1. **Index Cluster**

   * Uses a **B-tree index** on the cluster key to find the right block.
   * Most common cluster type.

2. **Hash Cluster**

   * Uses a **hash function** to determine the block location based on the cluster key.
   * Faster than index clusters for equality searches (e.g., `WHERE student_id = 101`).
   * Needs a fixed **HASHKEYS** number.

---

### **4️⃣ Creating an Index Cluster – Syntax**

```sql
-- Create cluster
CREATE CLUSTER cluster_name (column_name datatype [SIZE size_in_bytes])
TABLESPACE tablespace_name
STORAGE (INITIAL size NEXT size);

-- Create tables in cluster
CREATE TABLE table_name (
    col1 datatype,
    col2 datatype,
    ...
) CLUSTER cluster_name (column_name);

-- Create cluster index
CREATE INDEX index_name ON CLUSTER cluster_name;
```

---

### **5️⃣ Full Example – Index Cluster**

Let’s say we have `students` and `courses` tables, always joined on `student_id`.

#### **Step 1 – Create Cluster**

```sql
CREATE CLUSTER student_course_cluster (
    student_id NUMBER(5)
) SIZE 512
TABLESPACE users
STORAGE (INITIAL 10K NEXT 10K);
```

* **`SIZE 512`** → Suggested average row size for that cluster key.
* **`TABLESPACE users`** → Where the cluster is stored.
* **`STORAGE`** → How Oracle allocates space.

---

#### **Step 2 – Create Tables in Cluster**

```sql
CREATE TABLE students (
    student_id NUMBER(5) PRIMARY KEY,
    name       VARCHAR2(50)
) CLUSTER student_course_cluster (student_id);

CREATE TABLE courses (
    student_id  NUMBER(5),
    course_name VARCHAR2(50)
) CLUSTER student_course_cluster (student_id);
```

* The `(student_id)` in the `CLUSTER` clause **must match** the cluster key.

---

#### **Step 3 – Create Cluster Index**

```sql
CREATE INDEX idx_student_course_cluster
ON CLUSTER student_course_cluster;
```

* Required before inserting data in an **Index Cluster**.
* Without this, Oracle won’t know how to locate cluster key values.

---

#### **Step 4 – Insert Data**

```sql
INSERT INTO students VALUES (1, 'Akshit');
INSERT INTO courses VALUES (1, 'Oracle SQL');
INSERT INTO courses VALUES (1, 'PL/SQL Programming');
```

* Oracle will store all rows with `student_id = 1` **in the same block**.

---

#### **Step 5 – Query**

```sql
SELECT s.name, c.course_name
FROM students s
JOIN courses c
ON s.student_id = c.student_id;
```

* Oracle reads **one block** for `student_id = 1` and gets data from **both tables**.

---

### **6️⃣ Hash Clusters**

* Instead of using an index, Oracle **applies a hash function** to the cluster key to decide which block stores the rows.
* Good for **exact match lookups** (not ranges).

**Syntax:**

```sql
CREATE CLUSTER student_course_hash (
    student_id NUMBER(5)
)
HASHKEYS 500
SIZE 512;

-- Tables same as before
CREATE TABLE students (
    student_id NUMBER(5) PRIMARY KEY,
    name       VARCHAR2(50)
) CLUSTER student_course_hash (student_id);

CREATE TABLE courses (
    student_id  NUMBER(5),
    course_name VARCHAR2(50)
) CLUSTER student_course_hash (student_id);
```

> `HASHKEYS 500` means Oracle preallocates space for 500 hash values.

---

### **7️⃣ When to Use Clusters**

* **Yes**:

  * When you frequently join tables on the same key.
  * When data retrieval speed is more important than insert speed.

* **No**:

  * When tables are often accessed independently.
  * When you have high insert/update activity.

---